name: Build Multi-Platform Releases

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build APK
        run: flutter build apk --release
        
      - name: Create Android release package
        run: |
          mkdir -p releases/android
          cp build/app/outputs/flutter-apk/app-release.apk releases/android/LwenaTech-v${{ github.ref_name }}.apk
          
          cat > releases/android/INSTALL_ANDROID.txt << EOF
          LwenaTech Inventory Management System - Android Edition
          =========================================================
          
          INSTALLATION:
          1. Download LwenaTech-v${{ github.ref_name }}.apk to your Android device
          2. Enable "Install from Unknown Sources" in Settings > Security
          3. Tap the APK file to install
          4. Grant necessary permissions when prompted
          
          SYSTEM REQUIREMENTS:
          - Android 6.0 (API level 23) or later
          - 2GB RAM minimum
          - 50MB free storage space
          
          FEATURES:
          - Complete inventory management on mobile
          - Camera integration for product photos
          - Offline capability with cloud sync
          - Touch-optimized interface
          
          Version: ${{ github.ref_name }}
          Build Date: $(date)
          EOF
          
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: releases/android/

  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build Web
        run: flutter build web --release --base-href "/"
        
      - name: Create Web release package
        run: |
          mkdir -p releases/web
          cp -r build/web/* releases/web/
          
          cat > releases/web/DEPLOY_WEB.txt << EOF
          MemTechnology Inventory Management System - Web Edition
          =====================================================
          
          DEPLOYMENT:
          This folder contains the complete web application ready for deployment.
          
          HOSTING OPTIONS:
          1. Static hosting (Netlify, Vercel, GitHub Pages)
          2. Web server (Apache, Nginx)
          3. Cloud platforms (Firebase Hosting, AWS S3)
          
          REQUIREMENTS:
          - HTTPS required for camera features
          - Modern web browser (Chrome 80+, Firefox 75+, Safari 13+)
          
          Version: ${{ github.ref_name }}
          Build Date: $(date)
          EOF
          
          cd releases
          zip -r LwenaTech-Web-${{ github.ref_name }}.zip web/
          
      - name: Upload Web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-release
          path: releases/LwenaTech-Web-${{ github.ref_name }}.zip

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build Windows
        run: flutter build windows --release
        
      - name: Create Windows release package
        shell: bash
        run: |
          mkdir -p releases/windows
          cp -r build/windows/x64/runner/Release/* releases/windows/
          
          cat > releases/windows/install.bat << 'EOF'
          @echo off
          echo Installing LwenaTech Inventory Management System...
          echo.
          echo This will install the application to your Program Files.
          echo Please run as Administrator if needed.
          echo.
          pause
          
          set "INSTALL_DIR=%ProgramFiles%\LwenaTech"
          if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
          
          echo Copying files...
          xcopy /E /I /Y "%~dp0*" "%INSTALL_DIR%"
          
          echo Creating desktop shortcut...
          set "SHORTCUT=%USERPROFILE%\Desktop\LwenaTech Inventory.lnk"
          powershell -Command "$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%SHORTCUT%'); $Shortcut.TargetPath = '%INSTALL_DIR%\\LwenaTech.exe'; $Shortcut.WorkingDirectory = '%INSTALL_DIR%'; $Shortcut.Save()"
          
          echo.
          echo Installation complete!
          echo You can find the application on your desktop or in Start Menu.
          pause
          EOF
          
          cat > releases/windows/README.txt << EOF
          LwenaTech Inventory Management System - Windows Edition
          =========================================================
          
          INSTALLATION:
          1. Right-click on install.bat and select "Run as Administrator"
          2. Follow the installation prompts
          3. Launch from desktop shortcut or Start Menu
          
          SYSTEM REQUIREMENTS:
          - Windows 10 or later
          - 4GB RAM minimum
          - 100MB free disk space
          
          Version: ${{ github.ref_name }}
          Build Date: $(date)
          EOF
          
          cd releases
          powershell Compress-Archive -Path windows -DestinationPath LwenaTech-Windows-${{ github.ref_name }}.zip
          
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: releases/LwenaTech-Windows-${{ github.ref_name }}.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build macOS
        run: flutter build macos --release
        
      - name: Create macOS release package
        run: |
          mkdir -p releases/macos
          cp -r build/macos/Build/Products/Release/lwenatech.app releases/macos/
          
          cat > releases/macos/INSTALL_MACOS.txt << EOF
          LwenaTech Inventory Management System - macOS Edition
          =======================================================
          
          INSTALLATION:
          1. Download and extract the ZIP file
          2. Drag lwenatech.app to Applications folder
          3. Launch from Applications or Launchpad
          
          SYSTEM REQUIREMENTS:
          - macOS 10.14 or later
          - 4GB RAM minimum
          - 100MB free disk space
          
          Note: You may need to allow the app in System Preferences > Security & Privacy
          
          Version: ${{ github.ref_name }}
          Build Date: $(date)
          EOF
          
          cd releases
          zip -r LwenaTech-macOS-${{ github.ref_name }}.zip macos/
          
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: releases/LwenaTech-macOS-${{ github.ref_name }}.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build Linux
        run: flutter build linux --release
        
      - name: Create Linux release package
        run: |
          mkdir -p releases/linux
          cp -r build/linux/x64/release/bundle/* releases/linux/
          
          cat > releases/linux/install.sh << 'EOF'
          #!/bin/bash
          
          APP_NAME="LwenaTech Inventory"
          INSTALL_DIR="$HOME/.local/share/lwenatech"
          BIN_DIR="$HOME/.local/bin"
          DESKTOP_DIR="$HOME/.local/share/applications"
          
          echo "Installing $APP_NAME..."
          
          # Create directories
          mkdir -p "$INSTALL_DIR"
          mkdir -p "$BIN_DIR"
          mkdir -p "$DESKTOP_DIR"
          
          # Copy application files
          cp -r ./* "$INSTALL_DIR/"
          
          # Make executable
          chmod +x "$INSTALL_DIR/lwenatech"
          
          # Create symlink in bin
          ln -sf "$INSTALL_DIR/lwenatech" "$BIN_DIR/lwenatech"
          
          # Create desktop entry using printf to avoid YAML heredoc parsing issues
          printf '%s\n' "[Desktop Entry]" "Version=1.0" "Type=Application" "Name=LwenaTech Inventory" "Comment=Inventory Management System" "Exec=$INSTALL_DIR/lwenatech" "Icon=$INSTALL_DIR/data/flutter_assets/assets/app_icon.png" "Terminal=false" "Categories=Office;" > "$DESKTOP_DIR/lwenatech.desktop"
          
          echo "Installation complete!"
          echo "You can launch the app from your application menu or run 'lwenatech' in terminal."
          EOF
          chmod +x releases/linux/install.sh
          
          cat > releases/linux/INSTALL_LINUX.txt << EOF
          LwenaTech Inventory Management System - Linux Edition
          ========================================================

          INSTALLATION:
          1. Extract the downloaded file
          2. Open terminal in the extracted folder
          3. Run: chmod +x install.sh && ./install.sh
          4. Launch from application menu or run 'lwenatech' in terminal

          SYSTEM REQUIREMENTS:
          - Linux (Ubuntu 18.04+ or equivalent)
          - 4GB RAM minimum
          - 100MB free disk space
          - GTK 3.0+

          Version: ${{ github.ref_name }}
          Build Date: $(date)
          EOF
          
          cd releases
          tar -czf LwenaTech-Linux-${{ github.ref_name }}.tar.gz linux/
          
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: releases/LwenaTech-Linux-${{ github.ref_name }}.tar.gz

  create-release:
    needs: [build-android, build-web, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Create checksums
        run: |
          cd android-release
          sha256sum * > ../checksums.txt
          cd ../web-release
          sha256sum * >> ../checksums.txt
          cd ../windows-release
          sha256sum * >> ../checksums.txt
          cd ../macos-release
          sha256sum * >> ../checksums.txt
          cd ../linux-release
          sha256sum * >> ../checksums.txt
          cd ..
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            android-release/*
            web-release/*
            windows-release/*
            macos-release/*
            linux-release/*
            checksums.txt
          body: |
            ## LwenaTech Inventory Management System ${{ github.ref_name }}

            ### 📱 Multi-Platform Downloads

            **🤖 Android:**
            - Download: `LwenaTech-v${{ github.ref_name }}.apk`
            - Requirements: Android 6.0+, 2GB RAM
            - Install: Enable "Unknown Sources" and tap APK to install

            **🪟 Windows:**
            - Download: `LwenaTech-Windows-${{ github.ref_name }}.zip`
            - Requirements: Windows 10+, 4GB RAM
            - Install: Extract ZIP, right-click `install.bat` → "Run as Administrator"

            **🍎 macOS:**
            - Download: `LwenaTech-macOS-${{ github.ref_name }}.zip`
            - Requirements: macOS 10.14+, 4GB RAM
            - Install: Extract ZIP, drag app to Applications folder

            **🐧 Linux:**
            - Download: `LwenaTech-Linux-${{ github.ref_name }}.tar.gz`
            - Requirements: Ubuntu 18.04+ (or equivalent), 4GB RAM
            - Install: Extract, run `chmod +x install.sh && ./install.sh`

            **🌐 Web:**
            - Download: `LwenaTech-Web-${{ github.ref_name }}.zip`
            - Deploy to any web server or static hosting service
            - Access via: [Live Demo](https://your-app-url.netlify.app)
            
            ### ✨ Features
            - ✅ Multi-tenant inventory management
            - ✅ Real-time cloud synchronization
            - ✅ Image support for products
            - ✅ PDF reporting and exports
            - ✅ Cross-platform compatibility
            
            ### 🔐 Security
            File integrity can be verified using `checksums.txt`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}